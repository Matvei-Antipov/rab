# Инструкция по настройке Uchat для работы в локальной сети

## Обзор архитектуры

Uchat - это клиент-серверное приложение с следующей архитектурой:

```
┌─────────────────────────────────────────────────────────┐
│  ПК1 (Сервер)                                            │
│  ├── Oracle Database (пользователи, чаты, сообщения)   │
│  ├── MongoDB (настройки пользователей)                  │
│  ├── Redis (сессии, кэш, presence)                     │
│  └── Uchat.Server (ASP.NET Core Web API)                │
└─────────────────────────────────────────────────────────┘
                        │
                        │ HTTP + WebSocket
                        │
┌───────────────────────▼─────────────────────────────────┐
│  ПК2 (Клиент)                                           │
│  └── Uchat.Client (WPF приложение)                      │
└─────────────────────────────────────────────────────────┘
```

**Важно**: На одном ПК разворачиваются все БД и сервер, на втором ПК - только клиент, который подключается к серверу по сети.

---

## Шаг 1: Подготовка ПК1 (Сервер)

### 1.1. Установка необходимого ПО

#### .NET 8 SDK
```powershell
# Скачайте и установите .NET 8 SDK с https://dotnet.microsoft.com/download
# Проверьте установку:
dotnet --version
```

#### Oracle Database
1. Скачайте Oracle Database Express Edition (XE) с https://www.oracle.com/database/technologies/xe-downloads.html
2. Установите Oracle XE
3. Запомните пароль для пользователя SYS
4. По умолчанию Oracle слушает на порту **1521**

#### MongoDB
```powershell
# Скачайте MongoDB Community Server с https://www.mongodb.com/try/download/community
# Или используйте Chocolatey:
choco install mongodb

# Запустите MongoDB как службу:
net start MongoDB
```

#### Redis
```powershell
# Для Windows используйте Memurai (совместимый с Redis):
# Скачайте с https://www.memurai.com/
# Или используйте WSL2 с Redis:
wsl --install
# В WSL:
sudo apt-get update
sudo apt-get install redis-server
sudo service redis-server start
```

### 1.2. Настройка баз данных

#### Oracle - Создание пользователя и таблиц

1. Откройте SQL*Plus или SQL Developer
2. Подключитесь как SYS:
```sql
sqlplus sys/password@localhost:1521/XEPDB1 as sysdba
```

3. Создайте пользователя (если еще не создан):
```sql
CREATE USER uchat_admin IDENTIFIED BY "Blend100!";
GRANT CONNECT, RESOURCE, DBA TO uchat_admin;
GRANT UNLIMITED TABLESPACE TO uchat_admin;
```

4. Выполните скрипты создания таблиц:
```powershell
cd uchat-mvp\config\oracle
sqlplus uchat_admin/Blend100!@localhost:1521/XEPDB1 @01_create_users_table.sql
```

#### MongoDB - Проверка подключения

```powershell
# Проверьте, что MongoDB запущен:
mongosh "mongodb://localhost:27017"
```

База данных `uchat` и коллекция `user_preferences` будут созданы автоматически при первом использовании.

#### Redis - Проверка подключения

```powershell
# Если используете Memurai:
redis-cli -h localhost -p 6379 PING
# Должен вернуть: PONG

# Если используете Redis в WSL:
wsl redis-cli -h localhost -p 6379 PING
```

### 1.3. Определение IP-адреса ПК1

```powershell
# В PowerShell:
ipconfig

# Найдите IPv4-адрес вашей сетевой карты (например, 192.168.1.100)
# Запишите этот адрес - он понадобится для настройки клиента
```

**Пример**: `192.168.1.100`

---

## Важно про .env файлы

**Короткий ответ**: `.env` файл **НЕ нужен вообще** для:
- ✅ Локальной разработки на одном ПК
- ✅ Тестирования в локальной сети между двумя ПК

### Почему .env не нужен?

1. **Проект не использует .env файлы**:
   - В проекте нет пакетов для чтения .env (типа DotNetEnv)
   - ASP.NET Core по умолчанию не читает .env файлы
   - Все настройки хранятся в `appsettings.json`

2. **ПК1 (Сервер)**:
   - Все настройки в `appsettings.json` (CORS, строки подключения к БД, JWT и т.д.)
   - Просто отредактируйте этот файл - и всё работает

3. **ПК2 (Клиент)**:
   - `.env` файл **вообще не используется**
   - Клиент получает IP и порт сервера через аргументы командной строки:
     ```powershell
     dotnet run 192.168.1.100 5251
     ```

### Когда может понадобиться .env?

`.env` файлы упоминаются в `DEPLOYMENT.md` только как **опциональный** способ для **продакшена** (чтобы не хранить пароли в `appsettings.json`). Но даже для продакшена это не обязательно - можно использовать:
- Переменные окружения системы (без .env файла)
- Azure Key Vault
- Другие системы управления секретами

**Вывод**: Для разработки и локального тестирования `.env` файлы **не нужны и не используются**.

---

## Шаг 2: Настройка сервера на ПК1

### 2.1. Настройка CORS для разрешения подключений с других ПК

#### Вариант 1: Использование шаблона конфигурации (рекомендуется)

Скопируйте шаблон конфигурации для локальной сети:

```powershell
cd uchat-mvp\src\Uchat.Server
copy ..\..\config\appsettings.LocalNetwork.template.json appsettings.json
```

Затем отредактируйте `appsettings.json` и замените IP-адреса на реальные:
- `192.168.1.100` - IP-адрес ПК1 (сервера)
- `192.168.1.101` - IP-адрес ПК2 (клиента)
- Добавьте другие IP-адреса клиентов при необходимости

#### Вариант 2: Ручная настройка

Откройте файл `uchat-mvp\src\Uchat.Server\appsettings.json` и измените секцию `Cors`:

```json
{
  "Cors": {
    "AllowedOrigins": [
      "http://localhost:5000",
      "https://localhost:5001",
      "http://192.168.1.100:5251",
      "http://192.168.1.101:5251"
    ],
    "AllowCredentials": true,
    "PolicyName": "UchatCorsPolicy"
  }
}
```

**Важно**: 
- Замените `192.168.1.100` на IP-адрес ПК1
- Замените `192.168.1.101` на IP-адрес ПК2 (если известен)
- Добавьте IP-адреса всех клиентов, которые будут подключаться

#### Вариант 3: Для быстрого тестирования (небезопасно!)

**Только для тестирования в локальной сети!** Можно временно разрешить все источники:

```json
{
  "Cors": {
    "AllowedOrigins": [ "*" ],
    "AllowCredentials": false,
    "PolicyName": "UchatCorsPolicy"
  }
}
```

⚠️ **Не используйте этот вариант в продакшене!**

### 2.2. Настройка подключений к БД

Проверьте, что в `appsettings.json` правильно указаны строки подключения:

```json
{
  "Oracle": {
    "ConnectionString": "User Id=uchat_admin;Password=Blend100!;Data Source=localhost:1521/XEPDB1"
  },
  "MongoDB": {
    "ConnectionString": "mongodb://localhost:27017",
    "DatabaseName": "uchat"
  },
  "Redis": {
    "ConnectionString": "localhost:6379"
  }
}
```

### 2.3. Настройка брандмауэра Windows

Разрешите входящие подключения на порт сервера:

```powershell
# Замените 5251 на порт, который будете использовать
New-NetFirewallRule -DisplayName "Uchat Server" -Direction Inbound -LocalPort 5251 -Protocol TCP -Action Allow
```

Или через графический интерфейс:
1. Откройте "Брандмауэр Защитника Windows"
2. Нажмите "Дополнительные параметры"
3. Выберите "Правила для входящих подключений" → "Создать правило"
4. Выберите "Порт" → "TCP" → укажите порт (например, 5251)
5. Разрешите подключение

### 2.4. Сборка и запуск сервера

```powershell
cd uchat-mvp\src\Uchat.Server

# Сборка проекта
dotnet build

# Запуск сервера на порту 5251
dotnet run 5251
```

**Важно**: Сервер должен вывести сообщение:
```
Server started on port 5251
```

Если порт занят, выберите другой порт (например, 8080, 9000).

---

## Шаг 3: Подготовка ПК2 (Клиент)

### 3.1. Установка .NET 8 Runtime

```powershell
# Скачайте .NET 8 Desktop Runtime с https://dotnet.microsoft.com/download
# Это необходимо для запуска WPF приложения
```

### 3.2. Сборка клиента

```powershell
cd uchat-mvp\src\Uchat.Client

# Сборка проекта
dotnet build

# Или публикация для распространения:
dotnet publish -c Release -r win-x64 --self-contained -o ..\..\publish\client
```

### 3.3. Запуск клиента

Клиент запускается с двумя аргументами: IP-адрес сервера и порт.

```powershell
# Запуск из исходников:
dotnet run 192.168.1.100 5251

# Или если собрали publish:
cd ..\..\publish\client
.\Uchat.Client.exe 192.168.1.100 5251
```

**Где**:
- `192.168.1.100` - IP-адрес ПК1 (сервера)
- `5251` - порт, на котором запущен сервер

---

## Шаг 4: Проверка подключения

### 4.1. Проверка доступности сервера с ПК2

```powershell
# На ПК2 проверьте доступность сервера:
Test-NetConnection -ComputerName 192.168.1.100 -Port 5251

# Или через браузер откройте:
# http://192.168.1.100:5251/health
```

Должен вернуться ответ `Status: Healthy`.

### 4.2. Проверка WebSocket подключения

Если есть проблемы с WebSocket, проверьте:
1. Брандмауэр разрешает подключения на порт сервера
2. CORS настроен правильно
3. Сервер запущен и слушает на `0.0.0.0` (все интерфейсы)

---

## Шаг 5: Решение проблем

### Проблема: Клиент не может подключиться к серверу

**Решение**:
1. Проверьте, что сервер запущен на ПК1
2. Проверьте IP-адрес сервера: `ipconfig` на ПК1
3. Проверьте брандмауэр на ПК1
4. Проверьте, что оба ПК в одной сети
5. Попробуйте `ping 192.168.1.100` с ПК2

### Проблема: Ошибка CORS

**Решение**:
1. Убедитесь, что в `appsettings.json` на сервере добавлен IP клиента в `AllowedOrigins`
2. Или временно используйте `"*"` для тестирования
3. Перезапустите сервер после изменения конфигурации

### Проблема: База данных недоступна

**Решение**:
1. Проверьте, что Oracle/MongoDB/Redis запущены на ПК1
2. Проверьте строки подключения в `appsettings.json`
3. Проверьте логи сервера на наличие ошибок подключения

### Проблема: Порт занят

**Решение**:
1. Найдите процесс, использующий порт:
```powershell
netstat -ano | findstr :5251
```
2. Используйте другой порт при запуске сервера
3. Обновите настройки брандмауэра для нового порта

---

## Шаг 6: Автоматический запуск (опционально)

### Настройка автозапуска сервера на ПК1

Создайте файл `start-server.bat`:

```batch
@echo off
cd /d E:\uchat\Uchat-Develop\uchat-mvp\src\Uchat.Server
dotnet run 5251
pause
```

Создайте ярлык и добавьте в автозагрузку Windows.

### Настройка автозапуска клиента на ПК2

Создайте файл `start-client.bat`:

```batch
@echo off
cd /d E:\uchat\Uchat-Develop\uchat-mvp\src\Uchat.Client
dotnet run 192.168.1.100 5251
pause
```

---

## Краткая инструкция (быстрый старт)

### На ПК1 (Сервер):
```powershell
# 1. Установите Oracle, MongoDB, Redis
# 2. Настройте БД (создайте пользователя Oracle)
# 3. Отредактируйте appsettings.json - добавьте IP в CORS
# 4. Настройте брандмауэр
# 5. Запустите сервер:
cd uchat-mvp\src\Uchat.Server
dotnet run 5251
```

### На ПК2 (Клиент):
```powershell
# 1. Установите .NET 8 Runtime
# 2. Запустите клиент:
cd uchat-mvp\src\Uchat.Client
dotnet run <IP_ПК1> 5251
# Например: dotnet run 192.168.1.100 5251
```

---

## Дополнительные настройки

### Использование статического IP

Для стабильной работы рекомендуется настроить статический IP для ПК1:

1. Откройте "Параметры сети"
2. Выберите ваше подключение → "Свойства"
3. Выберите "Протокол Интернета версии 4 (TCP/IPv4)"
4. Установите статический IP (например, 192.168.1.100)

### Использование имени хоста вместо IP

Если настроен DNS в локальной сети, можно использовать имя компьютера:

```powershell
# На ПК2:
dotnet run PC1-SERVER 5251
```

Но для этого нужно настроить DNS или добавить запись в `C:\Windows\System32\drivers\etc\hosts` на ПК2:
```
192.168.1.100    PC1-SERVER
```

---

## Безопасность

⚠️ **Важно для продакшена**:
1. Не используйте `"*"` в CORS для продакшена
2. Используйте HTTPS вместо HTTP
3. Настройте аутентификацию для БД
4. Используйте сильные пароли
5. Ограничьте доступ к БД только с ПК1

---

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи сервера в консоли
2. Проверьте логи клиента в `%LOCALAPPDATA%\Uchat\Logs\`
3. Изучите документацию в папке `docs\`

